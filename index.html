<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>物联网管理员</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
		<link rel="stylesheet" href="../../layuiadmin/style/common.css" media="all">
		<link rel="stylesheet" type="text/css" href="../../layuiadmin/style/user/userCommon.css" />
		<link rel="stylesheet" href="../../layuiadmin/style/user/sscoconf.css" media="all">
		<style>

		</style>
	</head>

	<body>
		<!--[if lt IE 9]>
		<script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
		<script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
		<div class="container">
			<div class="header">
				<div class="layui-row">
					<div class="l-left">
						<label class="layui-form-label">是否对接W3</label>
						<div class="layui-input-block">
							<select name="boolSelect" lay-verify="required" value="1">
								<option value="0">否</option>
								<option value="1">是</option>
							</select>
						</div>
					</div>
					<div class="l-left">
						<a href="javascirpt:void(0);" class="btn-success">确定</a>

					</div>
				</div>
				<!--<div class="set-box">123123</div>-->
			</div>
			<div class="content">
				<h3 class="title">允许以下部门及用户以W3帐号登录本系统</h3>
				<div class="box">
					<div class="btn-box">
						<a href="#" class="btn-update" id="btn-update">新增</a>
						<a href="#" class="btn-delete">删除</a>
						<a href="#" class="btn-success">保存</a>
					</div>
					<div class="table-box">
						<div id="dataTable" lay-filter="dataTable"></div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../layuiadmin/layui/layui.js"></script>
		<script>
			layui.config({
				base: '../../layuiadmin/' //静态资源所在路径
			}).extend({
				index: 'lib/index' //主入口模块
			}).use(['index', 'common', 'table', 'laydate', 'form', 'element'], function() {
				var $ = layui.$,
					common = layui.common,
					table = layui.table,
					laydate = layui.laydate,
					form = layui.form,
					element = layui.element;
				form.on('select(levelSelect)', function(data) {
					//					debugger;
					//					console.log(data)
					var elem = $(data.elem);
					var trElem = elem.parents('tr');
					var tableData = table.cache['dataTable'];
					// 更新到表格的缓存数据中，才能在获得选中行等等其他的方法中得到更新之后的值
					tableData[trElem.data('index')]['contain'] = data.value;
					// 其他的操作看需求 TODO
				});
				form.on('select(autoSelect)', function(data) {
					//					debugger;
					//					console.log(data)
					var elem = $(data.elem);
					var trElem = elem.parents('tr');
					var tableData = table.cache['dataTable'];
					// 更新到表格的缓存数据中，才能在获得选中行等等其他的方法中得到更新之后的值
					tableData[trElem.data('index')]['authorizationType'] = data.value;
					// 其他的操作看需求 TODO
				});
				$('.btn-success').click(function() {
					var checkStatus = table.checkStatus('dataTable'); //test即为基础参数id对应的值
					console.log(checkStatus)
				});
				//				var orangeData = []
				var orangeData = new Array()
				$.get(layui.setter.base + 'json/user/ssoconf.json', function(res) {
					orangeData = res.data;
					loadTable(orangeData);
				})

				function loadTable(orangeData) {
					table.render({
						elem: '#dataTable',
						data: orangeData,
						minHeight: 300,
						//url: layui.setter.base + 'json/user/ssoconf.json', //模拟接口
						size: 'lg',
						cols: [
							[{
								type: 'checkbox',
								fixed: 'left'
							}, {
								field: 'authorizationType',
								title: '授权类型',
								templet: function(d) {
									return '<select name="author" class="sex layui-select" lay-filter="autoSelect" lay-verify="required" data-value="' + d.authorizationType + '" >\n' +
										'        <option value="0">是</option>\n' +
										'        <option value="1">否</option>\n' +
										'      </select>';
								}
							}, {
								//								field: 'userName',
								//								title: '名称',
								//								edit: 'true',
								//								sort: true
								field: 'userName',
								title: '名称',
								//								edit: 'true',
								sort: true,
								templet: function(d) {
									return '<select name="lalala" lay-search="" class="lalala layui-select" lay-filter="autoSelect" lay-verify="required">\n' +
										'      </select>';
								}
							}, {
								field: 'id',
								title: 'ID',
								edit: true,
								sort: true
							}, {
								field: 'contain',
								title: '是否包含所有下级部门',
								templet: function(d) {
									return '<select name="company" class="level layui-select" lay-filter="levelSelect" lay-verify="required" data-value="' + d.contain + '" >\n' +
										'        <option value="0">是</option>\n' +
										'        <option value="1">否</option>\n' +
										'      </select>';
								}
							}, {
								field: 'effectiveDate',
								title: '有效日期',
								templet: function(d) {
									//模板的实现方式也是多种多样，这里简单返回固定的
									return '<input class="date-box dateSet' + d.LAY_INDEX + ' layui-input layui-unselect" lay-filter="boxDate" data-value="' + d.effectiveDate + '" value="' + d.effectiveDate + '" />';
								}
							}]
						],
						page: true,
						limit: 15,
						text: '加载出现异常,请重试',
						//渲染表格后的回调
						done: function(res, curr, count) {
							$('.layui-laypage-limits').css('display','none')
							$('.layui-table-main').css('min-height','200px')
							//							console.log(res)
							//						count || this.elem.next('.layui-table-view').find('.layui-table-header').css('overflow', 'auto');
							$('.layui-table-body').css('overflow', 'hidden');
							layui.each($('select'), function(index, item) {
								var elem = $(item);
								elem.val(elem.data('value')).parents('div.layui-table-cell').css('overflow', 'visible');
							});
							//配置日期控件
							for (var i = 1; i <= res.data.length; i++) {
								laydate.render({
									elem: ".dateSet" + i,
									done: function(data) {
										var elem = $(this.elem);
										var trElem = elem.parents('tr');
										var tableData = table.cache['dataTable'];
										// 更新到表格的缓存数据中，才能在获得选中行等等其他的方法中得到更新之后的值
										tableData[trElem.data('index')]['effectiveDate'] = data;
									}
								})
							}
							//执行一遍form.render()
							form.render()
								//下拉框样式调整
							$(function() {
								format('company')
								format('author')
								format('lalala', '300')

								function format(obj, heightObj) {
									var fuTop = 84 || heightObj;
									var tar = $("select[name='" + obj + "']")
									if(tar.length<4){
										return ;
									}
									for (var t = 0; t < tar.length; t++) {
										if (t == tar.length - 1) {
											tar.eq(t).parent().find(".layui-anim-upbit").css('top', '-' + fuTop + 'px')
										}
										if (t == tar.length - 2) {
											tar.eq(t).parent().find(".layui-anim-upbit").css('top', '-' + fuTop + 'px')
										}
									}
								}
							})
						}
					});
				}
				//监听edit
				//				table.on('edit(dataTable)', function(obj) {
				//					var value = obj.value //得到修改后的值
				//						,
				//						dataAll = obj.data //得到所在行所有键值
				//						,
				//						field = obj.field; //得到字段
				//					console.log(dataAll)
				//					$.ajax({
				//						type: 'get',
				//						url: layui.setter.base + 'json/user/userid.json',
				//						success: function(result) {
				//							for (var i = 0; i < result.data.length; i++) {
				//								if (value == result.data[i].username) {
				//									layer.msg('获取id：' + result.data[i].userid)
				//									dataAll.id = result.data[i].userid
				//									table.reload('dataTable', {
				//										
				//									})
				//									return;
				//								}
				//							}
				//							layer.msg('无法获取id');
				//						}
				//					})
				//				});
				//select search键盘时间
				$(".layui-input").on('keyup', function(e) {
						var tarSel = $(this).parent().find("select[name='lalala']")
						console.log(tarSel)
						console.log(e)
					})
					//排序回调
				table.on('sort(dataTable)', function(obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
					//					console.log(obj); //当前排序的字段名
					//尽管我们的 table 自带排序功能，但并没有请求服务端。
					//有些时候，你可能需要根据当前排序的字段，重新向服务端发送请求，从而实现服务端排序，如：
					table.reload('dataTable', {
						initSort: obj //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
							,
						where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
							field: [obj.id, obj.userName, obj.authorizationType, obj.effectiveDate, obj.contain] //排序字段
								,
							order: obj.type //排序方式
						}
					});
				});
				//保存
				//删除
				//新增
				$('#btn-update').on('click', function() {
					var count = $('.layui-laypage-count').text()
//					if(count == '共 10 条'){
//						layer.msg('一页最多十条数据')
//						return 
//					}
					var oldData = table.cache['dataTable']
					var addData = {
						LAY_CHECKED: false,
						LAY_TABLE_INDEX: 4,
						authorizationType: "1",
						contain: "1",
						effectiveDate: "2018-09-12",
						id: "",
						userName: ""
					}
					oldData.push(addData)
					table.reload('dataTable', {
						data: oldData
					})
				})
			})
		</script>
	</body>

</html>

<!-- json -->
{
	"code": 0,
	"msg": "操作成功",
	"count": "4",
	"data": [
		{
			"LAY_CHECKED": false,
			"authorizationType": "1",
			"userName": "O(∩_∩)O哈哈哈~",
			"id": "wxz5001484",
			"contain": "1",
			"effectiveDate": "2018-03-28"
		},
		{
			"LAY_CHECKED": false,
			"authorizationType": "0",
			"userName": "制造部",
			"id": "55783",
			"contain": "0",
			"effectiveDate": "2018-03-28"
		},
		{
			"LAY_CHECKED": false,
			"authorizationType": "1",
			"userName": "嘤嘤嘤",
			"id": "wxz5001482",
			"contain": "1",
			"effectiveDate": "2018-03-28"
		},{
			"LAY_CHECKED": false,
			"authorizationType": "0",
			"userName": "工商部",
			"id": "55783",
			"contain": "1",
			"effectiveDate": "2018-03-28"
		}
	]
}
